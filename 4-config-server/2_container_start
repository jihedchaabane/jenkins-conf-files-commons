pipeline {
    agent any
    environment {
        // Nom de l'image Docker
        DOCKER_IMAGE = 'jihed123/springboot-conf-config-server:0.0.1-SNAPSHOT'
        // Nom du conteneur
        CONTAINER_NAME = 'container-springboot-conf-config-server'
        // Port de l'application
        APP_PORT = '8762'
        // common-network
        DOCKER_NETWORK = 'springboot-network'
		
		// eureka-server url.
        EUREKA_URL = 'http://container-springboot-conf-eureka-server:8761/eureka/'
        CONFIG_REPO_ADDR = 'file:///config-repo'
        CONFIG_REPO_BRANCH = 'master'
    }
    stages {

        stage('Start config-server') {
            steps {
                script {
                    // Arrêter et supprimer tout conteneur existant
                    sh """
                        docker stop ${CONTAINER_NAME} || true
                        docker rm ${CONTAINER_NAME} || true
                    """
                    
					// Démarrer sur la network 'springboot-network'
                    sh """
                        docker run \
                        -v /var/lib/jenkins/workspace/spring-boot-conf-config-server-repo:/config-repo \
                        -e EUREKA_ADDR=${EUREKA_URL} \
                        -e CONFIG_REPO_ADDR=${CONFIG_REPO_ADDR} \
                        -e CONFIG_REPO_BRANCH=${CONFIG_REPO_BRANCH} \
                        -d --name ${CONTAINER_NAME} --network ${DOCKER_NETWORK} \
                        -p ${APP_PORT}:${APP_PORT} ${DOCKER_IMAGE}
                    """
                }
            }
        }

        stage('Verify Container') {
            steps {
                script {
                    sh """
                        sleep 10
                        docker ps --filter "name=${CONTAINER_NAME}" --filter "status=running" | grep ${CONTAINER_NAME}
                        docker logs ${CONTAINER_NAME}
                    """

					// Vérifier que le container est prêt
                    sh """
                        for i in {1..10}; do
                            curl -v --fail http://localhost:${APP_PORT}/actuator/health && break
                            echo "Attente de l'application... (\$i/10)"
                            sleep 5
                        done
                        curl -v --fail http://localhost:${APP_PORT}/actuator/health || exit 1
                    """
                }
            }
        }
    }
    post {
//      always {
//      }
        success {
            echo 'Container démarré avec succès !'
        }
        failure {
            echo 'Echec du démarrage du Container !'
        }
    }
}